(function(){"use strict";const Mt=function*(e,t,n){for(let r=e;r<=t;r+=n)yield r};function ye(e,t,n=1){return[...Mt(e,t,n)]}function Fe(...e){return e.reduce((t,n)=>t.flatMap(r=>n.map(s=>[r,[s]].flat())),[[]])}function Pe(e,t=[],n,r){n(e,t)?r(e,t):e&&typeof e=="object"&&Object.entries(e).forEach(([s,o])=>Pe(o,[...t,s],n,r))}function re(e,t){return Object.fromEntries(Object.entries(e).map(([n,r],s)=>[n,t(r,n,s)]))}function M(e,t){return Object.fromEntries(e.map((n,r)=>[n,t(n,r)]))}function he(e,t){return Object.fromEntries(e.map((n,r)=>t(n,r)))}function kt(e,t){if(!(!e||!t))return t.reduce((n,r)=>n==null?void 0:n[r],e)}function Z(e){throw new Error(`Should not reach this with value ${e}`)}const Xe=["Adventurer","ArchaicPetra","Berserker","BlizzardStrayer","BloodstainedChivalry","BraveHeart","CrimsonWitchOfFlames","DeepwoodMemories","DefendersWill","DesertPavilionChronicle","EchoesOfAnOffering","EmblemOfSeveredFate","FlowerOfParadiseLost","Gambler","GildedDreams","GladiatorsFinale","GoldenTroupe","HeartOfDepth","HuskOfOpulentDreams","Instructor","Lavawalker","LuckyDog","MaidenBeloved","MarechausseeHunter","MartialArtist","NighttimeWhispersInTheEchoingWoods","NoblesseOblige","NymphsDream","OceanHuedClam","PaleFlame","PrayersForDestiny","PrayersForIllumination","PrayersForWisdom","PrayersToSpringtime","ResolutionOfSojourner","RetracingBolide","Scholar","ShimenawasReminiscence","SongOfDaysPast","TenacityOfTheMillelith","TheExile","ThunderingFury","Thundersoother","TinyMiracle","TravelingDoctor","VermillionHereafter","ViridescentVenerer","VourukashasGlow","WanderersTroupe"],B=["flower","plume","sands","goblet","circlet"],ve=["physical",...["anemo","geo","electro","hydro","pyro","cryo","dendro"]],$t=["mondstadt","liyue","inazuma","sumeru","fontaine","natlan","snezhnaya","khaenriah"],Ot=["hydro","pyro","cryo","electro"],I=le(1),fe=le(0),xt=R("none");function R(e,t){return typeof e=="number"?{operation:"const",operands:[],type:"number",value:e,info:t}:{operation:"const",operands:[],type:"string",value:e,info:t}}function le(e,t){return e>=Number.MAX_VALUE/100&&(e=1/0),e<=-Number.MAX_VALUE/100&&(e=-1/0),R(e,{unit:"%",...t})}const Et={};let Rt=0;const St=()=>`path_${Rt++}`;function T(e,t){if(t){const{name:n,icon:r,textSuffix:s,...o}=t;e.info={...e.info,...o},(n||r||s)&&(e.info.path=e.info.path??St(),Et[e.info.path]={name:n,icon:r,textSuffix:s})}return e}function G(e,t,n,r){return{operation:"lookup",operands:n!=="none"?[z(e),z(n)]:[z(e)],table:t,info:r}}function _e(...e){return{operation:"min",operands:se(e)}}function ze(...e){return{operation:"max",operands:se(e)}}function _(...e){return{operation:"add",operands:se(e)}}function x(...e){return{operation:"mul",operands:se(e)}}function ce(e,t){return{operation:"sum_frac",operands:se([e,t])}}function Nt(e){return{operation:"res",operands:se([e])}}function q(e,t,n,r){return{operation:"match",operands:[z(e),z(t),ke(n,r),z(0)],emptyOn:"unmatch"}}function jt(e,t,n,r){return{operation:"match",operands:[z(e),z(t),z(0),ke(n,r)],emptyOn:"match"}}function Dt(e,t,n,r){return{operation:"match",operands:[z(e),z(t),z(void 0),ke(n,r)],emptyOn:"match"}}function Je(e,t,n,r){return{operation:"threshold",operands:[z(e),z(t),ke(n,r),z(0)],emptyOn:"l"}}function It(e,t,n,r,s){return{operation:"threshold",operands:[z(e),z(t),z(n),z(r)],info:s}}function we(e,t=[]){if(e.operation){if(e.operation!=="read")throw new Error(`Found ${e.operation} node while making reader`);return{...e,path:t}}else return M(Object.keys(e),n=>we(e[n],[...t,n]))}function Qe(e,t){return{operation:"data",operands:[e],data:t}}function Ct(e,t="add",n){return{operation:"read",operands:[],path:["dyn",e],accu:t,type:"number",info:n}}function $(e,t){return{operation:"read",operands:[],path:[],accu:e,info:t,type:"number"}}function A(e){return{operation:"read",operands:[],path:[],accu:e,type:"string"}}function Ft(...e){return{operation:"prio",operands:se(e)}}function Me(e,t,n){return{operation:"subscript",operands:[e],list:t,info:n}}function se(e){return e.map(t=>typeof t=="object"?t:R(t))}function z(e){return typeof e!="object"?R(e):e}function ke(e,t){return t?typeof e!="object"?R(e,t):T({...e},t):z(e)}function Be(e){const t=new Map;function n(r){if(typeof r!="object")return r;const s=t.get(r);if(s)return s;const o=Array.isArray(r)?r.map(i=>n(i)):Object.fromEntries(Object.entries(r).map(([i,a])=>[i,i==="info"?a:n(a)]));return t.set(r,o),o}return n(e)}function $e(e,t,n){const r=new Set,s=new Set;function o(i){if(!s.has(i)){if(r.has(i)){console.error("Found cyclical dependency during formula traversal");return}r.add(i),t(i),i.operands.forEach(o),n(i),r.delete(i),s.add(i)}}e.forEach(o)}function ge(e,t,n){const r=new Set,s=new Map,o=new Map;function i(l){let c=s.get(l);if(c)return c;c=t(l);let g=o.get(c);return g||(r.has(c)?(console.error("Found cyclical dependency during formula mapping"),R(NaN)):(r.add(c),g=n(a(c),l),r.delete(c),s.set(l,g),o.set(c,g),g))}function a(l){const c=l.operands.map(i);return Ze(c,l.operands)?l:{...l,operands:c}}const d=e.map(i);return Ze(d,e)?e:d}function Ye(e,t,n){const r=new Map;function s(o,i){let a=r.get(i);a||r.set(i,a=[new Set,new Map]);const[d,l]=a,c=l.get(o);if(c)return c;if(d.has(o))throw new Error("Found cyclical dependency during formula mapping");d.add(o);const g=n(o,i,s);return l.set(o,g),d.delete(o),g}return e.map(o=>s(o,t))}function Ze(e,t){return e===void 0?t===void 0:t===void 0?!1:e.length===t.length&&e.every((n,r)=>n===t[r])}const Te={physical:{name:"Physical"},anemo:{name:"Anemo"},geo:{name:"Geo"},electro:{name:"Electro"},hydro:{name:"Hydro"},pyro:{name:"Pyro"},cryo:{name:"Cryo"},dendro:{name:"Dendro"}},Pt={normal:"Normal Att.",charged:"Charged Att.",plunging:"Plunging Att.",plunging_collision:"Plunging Collision",plunging_impact:"Plunging Impact",elemental:"Elemental Att.",skill:"Ele. Skill",burst:"Ele. Burst"},ee={overloaded:{name:"Overloaded",multi:2,variants:["pyro"],resist:"pyro",canCrit:!1},shattered:{name:"Shattered",multi:1.5,variants:["physical"],resist:"physical",canCrit:!1},electrocharged:{name:"Electro-Charged",multi:1.2,variants:["electro"],resist:"electro",canCrit:!1},superconduct:{name:"Superconduct",multi:.5,variants:["cryo"],resist:"cryo",canCrit:!1},swirl:{name:"Swirl",multi:.6,variants:["pyro","hydro","electro","cryo"],resist:"pyro",canCrit:!1},burning:{name:"Burning",multi:.25,variants:["pyro","dendro"],resist:"pyro",canCrit:!0},bloom:{name:"Bloom",multi:2,variants:["dendro","hydro"],resist:"dendro",canCrit:!0},burgeon:{name:"Burgeon",multi:3,variants:["pyro"],resist:"dendro",canCrit:!0},hyperbloom:{name:"Hyperbloom",multi:3,variants:["electro"],resist:"dendro",canCrit:!0}},Ae=["burning","bloom","burgeon","hyperbloom"],zt={vaporize:{name:"Vaporize",variants:{pyro:1.5,hydro:2}},melt:{name:"Melt",variants:{pyro:2,cryo:1.5}}},Bt={spread:{name:"Spread",multi:1.25},aggravate:{name:"Aggravate",multi:1.15}},Ve=[-1,17.165606,18.535048,19.904854,21.274902,22.6454,24.649612,26.640642,28.868587,31.36768,34.143345,37.201,40.66,44.446667,48.56352,53.74848,59.081898,64.420044,69.72446,75.12314,80.58478,86.11203,91.70374,97.24463,102.812645,108.40956,113.20169,118.102905,122.97932,129.72733,136.29291,142.67085,149.02902,155.41699,161.8255,169.10631,176.51808,184.07274,191.70952,199.55692,207.38205,215.3989,224.16566,233.50217,243.35057,256.06308,268.5435,281.52606,295.01364,309.0672,323.6016,336.75754,350.5303,364.4827,378.61917,398.6004,416.39825,434.387,452.95105,472.60623,492.8849,513.56854,539.1032,565.51056,592.53876,624.4434,651.47015,679.4968,707.79407,736.67145,765.64026,794.7734,824.67737,851.1578,877.74207,914.2291,946.74677,979.4114,1011.223,1044.7917,1077.4437,1109.9976,1142.9766,1176.3695,1210.1844,1253.8357,1288.9528,1325.4841,1363.4569,1405.0974,1446.8535],Tt=[-1,91.1791,98.707664,106.23622,113.76477,121.29332,128.82188,136.35042,143.87898,151.40752,158.93608,169.99149,181.07625,192.19037,204.0482,215.939,227.86275,247.68594,267.5421,287.4312,303.82642,320.22522,336.62762,352.31927,368.01093,383.70255,394.43237,405.18146,415.94992,426.73764,437.5447,450.6,463.7003,476.84558,491.1275,502.55457,514.0121,531.4096,549.9796,568.5849,584.9965,605.67035,626.3862,646.0523,665.7556,685.4961,700.8394,723.3331,745.8653,768.4357,786.79193,809.5388,832.32904,855.16266,878.0396,899.4848,919.362,946.0396,974.7642,1003.5786,1030.077,1056.635,1085.2463,1113.9244,1149.2587,1178.0648,1200.2238,1227.6603,1257.243,1284.9174,1314.7529,1342.6652,1372.7524,1396.321,1427.3124,1458.3745,1482.3358,1511.9109,1541.5493,1569.1537,1596.8143,1622.4197,1648.074,1666.3761,1684.6782,1702.9803,1726.1047,1754.6715,1785.8666,1817.1375,1851.0603];ve.map(e=>`${e}_dmg_`),ve.map(e=>`${e}_res_`);const At=ve.map(e=>`${e}_enemyRes_`);Object.entries(Te).forEach(([e,{name:t}])=>{}),Object.entries(Pt).forEach(([e,t])=>{}),Object.entries(ee).forEach(([e,{name:t}])=>{}),Object.entries(ee).forEach(([e,{name:t}])=>{e==="swirl"&&ee.swirl.variants.forEach(n=>{`${Te[n].name}${t}`})}),Ae.forEach(e=>{`${ee[e].name}`,`${ee[e].name}`}),["cryo","hydro","pyro","electro"].forEach(e=>{`${Te[e].name}`}),Object.entries(zt).forEach(([e,{name:t}])=>{}),Object.entries(Bt).forEach(([e,{name:t}])=>{});function w(e){return{path:e}}const et=!0,J=!0,L=ve,ue=["auto","skill","burst"],de=["normal","charged","plunging_collision","plunging_impact","skill","burst","elemental"],tt=["hp","hp_","atk","atk_","def","def_","eleMas","enerRech_","critRate_","critDMG_","electro_dmg_","hydro_dmg_","pyro_dmg_","cryo_dmg_","physical_dmg_","anemo_dmg_","geo_dmg_","dendro_dmg_","heal_"],nt=["overloaded","shattered","electrocharged","superconduct","swirl","burning","bloom","burgeon","hyperbloom"],rt=["vaporize","melt"],st=["spread","aggravate"],Vt=["stamina","staminaDec_","staminaSprintDec_","staminaGlidingDec_","staminaChargedDec_","incHeal_","shield_","cdRed_","moveSPD_","atkSPD_","weakspotDMG_","dmgRed_","healInc"],Gt=["base_atk","base_hp","base_def"],be=[...tt,...["all",...nt,...rt,...st,...de,"plunging","normalEle"].map(e=>`${e}_dmg_`)],Oe=[...L.flatMap(e=>[`${e}_dmgInc`,`${e}_critDMG_`,`${e}_res_`]),...ue.map(e=>`${e}Boost`),...[...de,"plunging"].flatMap(e=>[`${e}_dmgInc`,`${e}_critDMG_`,`${e}_critRate_`]),...Ae.flatMap(e=>[`${e}_critRate_`,`${e}_critDMG_`]),"all_dmgInc",...At,"enemyDefRed_","enemyDefIgn_",...Vt,...Gt];[...be,...Oe];const at=M(ue,e=>$()),ae=M(be,e=>$(void 0,w(e))),X=M(Oe,e=>$(void 0,w(e)));for(const e of L)X[`${e}_res_`].info.variant=e,X[`${e}_enemyRes_`].info.variant=e,X[`${e}_critDMG_`].info.variant=e,X[`${e}_dmgInc`].info.variant=e,ae[`${e}_dmg_`].info.variant=e;for(const e of[...nt,...rt,...st])ae[`${e}_dmg_`].info.variant=e;Ae.forEach(e=>{X[`${e}_critRate_`].info.variant=e,X[`${e}_critDMG_`].info.variant=e}),X.healInc.info.variant="heal",X.incHeal_.info.variant="heal",ae.heal_.info.variant="heal";function xe(e,t){return t=Be(t),Pe(t,[],n=>n.operation,n=>n.info={...e,...n.info}),t}function Ut(e,t){Pe(t,[],n=>n.operation,n=>{n.operation==="read"&&n.type==="number"&&(n.accu=e)})}const Ht={activeCharKey:A(),charKey:A(),charEle:A(),weaponType:A(),lvl:$(void 0,{...w("level"),prefix:"char"}),constellation:$(),asc:$(),special:$(),infusion:{overridableSelf:A("small"),nonOverridableSelf:A("small"),team:A("small")},base:M(["atk","hp","def"],e=>$("add",w(e))),customBonus:xe({prefix:"custom",pivot:J},{...ae,...X}),premod:{...at,...ae,...X},total:xe({prefix:"total",pivot:J},{...at,...he(ue,e=>[`${e}Index`,$()]),...ae,...X,cappedCritRate:$(void 0,w("critRate_"))}),art:xe({prefix:"art",asConst:et},{...M(tt,e=>ae[e]),...M(B,e=>({id:A(),set:A()}))}),artSet:M(Xe,e=>$("add",{path:e})),weapon:xe({prefix:"weapon",asConst:et},{id:A(),key:A(),type:A(),lvl:$(),asc:$(),refinement:$(),main:$(),sub:$(),sub2:$()}),enemy:{def:$("add",{...w("enemyDef_multi_"),pivot:J}),transDef:$("add",{...w("enemyDef_multi_"),pivot:J}),...M(L.map(e=>`${e}_resMulti_`),e=>$()),level:$(void 0,w("enemyLevel")),...he(L,e=>[`${e}_res_`,$(void 0,{prefix:"base",...w(`${e}_enemyRes_`)})]),defRed:$(void 0),defIgn:$("add",{...w("enemyDefIgn_"),pivot:J})},hit:{reaction:A(),ele:A(),move:A(),hitMode:A(),base:$("add",w("base")),ampMulti:$(),addTerm:$(void 0,{pivot:J}),dmgBonus:$("add",{...w("dmg_"),pivot:J}),dmgInc:$("add",w("dmgInc")),dmg:$()}},D=we(Be(Ht)),{base:ot,customBonus:Ee,premod:H,total:S,art:it,hit:F,enemy:te}=D;Ut("add",{customBonus:Ee,premod:H,art:it,total:M(be,e=>S[e])}),ot.atk.info={...w("atk"),prefix:"base",pivot:J},delete S.critRate_.info.pivot,S.critRate_.info.prefix="uncapped";const Re=T(_(I,x(25/9,ce(S.eleMas,1400))),{...w("base_amplifying_multi_"),pivot:J}),lt=_(I,x(5,ce(S.eleMas,1200)));M(["atk","def","hp"],e=>D.customBonus[`base_${e}`]),{...M(ue,e=>H[`${e}Boost`]),...M(Oe,e=>{const t=[];e.endsWith("_enemyRes_")&&t.push(te[e.replace(/_enemyRes_$/,"_res_")]);const n=[...t,Ee[e]].filter(r=>r);return n.length===1?n[0]:_(...n)}),...M(be,e=>{const t=[],n=w(e);switch(e){case"atk":case"def":case"hp":t.push(x(ot[e],_(I,H[`${e}_`])));break;case"critRate_":t.push(le(.05,{...n,prefix:"default"}),G(F.move,M(de,s=>s.includes("plunging")?_(H[`${s}_critRate_`],H.plunging_critRate_):H[`${s}_critRate_`]),0));break;case"critDMG_":t.push(le(.5,{...w,prefix:"default"}),G(F.ele,M(L,s=>H[`${s}_critDMG_`]),0),G(F.move,M(de,s=>s.includes("plunging")?_(H[`${s}_critDMG_`],H.plunging_critDMG_):H[`${s}_critDMG_`]),0));break;case"enerRech_":t.push(le(1,{...w,prefix:"default"}));break}const r=[...t,it[e],Ee[e]].filter(s=>s);return r.length===1?r[0]:_(...r)})},{...M(ue,e=>H[e]),...M(be,e=>H[e]),...M(Oe,e=>H[e]),...he(ue,e=>[`${e}Index`,_(S[e],-1)]),stamina:_(R(100,{...w("stamina"),prefix:"default"}),Ee.stamina),cappedCritRate:ze(_e(S.critRate_,I),fe)},_(S.all_dmg_,G(F.move,M(de,e=>e.includes("plunging")?_(S[`${e}_dmg_`],S.plunging_dmg_):S[`${e}_dmg_`]),fe),G(F.ele,M(L,e=>S[`${e}_dmg_`]),fe),q(F.move,"normal",jt(F.ele,"physical",S.normalEle_dmg_))),_(T(_(S.all_dmgInc,G(F.ele,M(L,e=>S[`${e}_dmgInc`]),NaN),G(F.move,M(de,e=>e.includes("plunging")?_(S[`${e}_dmgInc`],S.plunging_dmgInc):S[`${e}_dmgInc`]),NaN)),{...w("dmgInc"),pivot:J}),F.addTerm),G(F.reaction,{spread:q(F.ele,"dendro",x(Me(D.lvl,Ve),1.25,_(lt,S.spread_dmg_)),w("spread_dmgInc")),aggravate:q(F.ele,"electro",x(Me(D.lvl,Ve),1.15,_(lt,S.aggravate_dmg_)),w("aggravate_dmgInc"))},fe),x(_(F.base,F.dmgInc),_(I,F.dmgBonus),G(F.hitMode,{hit:I,critHit:_(I,S.critDMG_),avgHit:_(I,x(S.cappedCritRate,S.critDMG_))},NaN),te.def,G(F.ele,M(L,e=>te[`${e}_resMulti_`]),NaN),F.ampMulti),G(F.reaction,{vaporize:G(F.ele,{hydro:x(R(2,w("vaporize_multi_")),_(Re,S.vaporize_dmg_)),pyro:x(R(1.5,w("vaporize_multi_")),_(Re,S.vaporize_dmg_))},I),melt:G(F.ele,{pyro:x(R(2,w("melt_multi_")),_(Re,S.melt_dmg_)),cryo:x(R(1.5,w("melt_multi_")),_(Re,S.melt_dmg_))},I)},I),{def:ce(_(D.lvl,100),x(_(te.level,100),_(I,x(-1,te.defRed)),_(I,x(-1,te.defIgn)))),transDef:ce(99999999,x(_(x(5,te.level),500),_(I,x(-1,te.defRed)),_(I,x(-1,te.defIgn)))),defRed:S.enemyDefRed_,...he(L,e=>[`${e}_resMulti_`,Nt(S[`${e}_enemyRes_`])])},we(Be(D),["target"]);const ct=we({...M([...L,...$t],e=>$("add")),maxEleMas:$("max")},["tally"]);({...ct,ele:_(...L.map(e=>_e(ct[e],1)))});const ne=Ft(D.infusion.nonOverridableSelf,Dt(D.infusion.team,xt,D.infusion.team),D.infusion.overridableSelf),ut={min:e=>Math.min(...e),max:e=>Math.max(...e),add:e=>e.reduce((t,n)=>t+n,0),mul:e=>e.reduce((t,n)=>t*n,1)},Q={...ut,res:([e])=>e<0?1-e/2:e>=.75?1/(e*4+1):1-e,sum_frac:e=>e[0]/e.reduce((t,n)=>t+n),threshold:([e,t,n,r])=>e>=t?n:r},Kt=new Set(Object.keys(ut));function dt(e,t,n=r=>!1){let r=Ue(e,t,n);return r=Wt(r),r=Ue(r,{}),Lt(r)}function qt(e,t,n,r){let s=`
"use strict";
function res(res) {
  if (res < 0) return 1 - res / 2
  else if (res >= 0.75) return 1 / (res * 4 + 1)
  return 1 - res
}
const x0=0`,o=1;const i=new Map;return $e(e,a=>{},a=>{const{operation:d,operands:l}=a,c=`x${o++}`,g=l.map(p=>i.get(p));switch(i.set(a,c),d){case"read":{const p=n(a);let h=r?new Array(r).fill(null).map((u,m)=>`(b[${m}].values["${p}"] ?? 0)`):["0"];t[p]&&t[p]!==0&&(h=[t[p].toString(),...h]),s+=`,${c}=${h.join("+")}
`;break}case"const":i.set(a,`(${a.value})`);break;case"add":case"mul":s+=`,${c}=${g.join(d==="add"?"+":"*")}
`;break;case"min":case"max":s+=`,${c}=Math.${d}(${g})
`;break;case"threshold":{const[p,h,u,m]=g;s+=`,${c}=(${p}>=${h})?${u}:${m}
`;break}case"res":s+=`,${c}=res(${g[0]})
`;break;case"sum_frac":s+=`,${c}=${g[0]}/(${g[0]}+${g[1]})
`;break;default:Z(d)}}),s+=`;
return [${e.map(a=>i.get(a))}]`,new Function("b",s)}function Wt(e){return ge(e,t=>t,t=>{let n=t;if(Kt.has(t.operation)){const r=t,{operation:s}=r;let o=!1;const i=r.operands.flatMap(a=>a.operation===s?(o=!0,a.operands):[a]);n=o?{...r,operands:i}:r}return n})}function Ge(e,t,n){if(e.length!==t.length)return e.length-t.length;for(let r=0;r<e.length;r++){const s=n(e[r],t[r]);if(s!==0)return s}return 0}function Lt(e){const t=new Map,n=[[]];$e(e,a=>{},a=>{switch(a.operation){case"const":case"read":n[0].push(a),t.set(a,0);break;default:{const d=Math.max(...a.operands.map(l=>t.get(l)))+1;n.length<=d&&n.push([]),n[d].push(a),t.set(a,d);break}}});function r(a,d){const l=t.get(a),c=t.get(d);if(l!==c)return l-c;const g=a.operation,p=d.operation;if(g!==p)return g.localeCompare(p);switch(g){case"const":if(g!==p)throw Error("ily jslint");return a.value-d.value;case"read":if(g!==p)throw Error("ily jslint");return Ge(a.path,d.path,(h,u)=>h.localeCompare(u));case"res":case"threshold":case"sum_frac":{if(g!==p)throw Error("ily jslint");const h=a.operands.map(m=>o.get(m)),u=d.operands.map(m=>o.get(m));return Ge(h,u,(m,f)=>m-f)}case"add":case"mul":case"min":case"max":{if(g!==p)throw Error("ily jslint");const h=a.operands.map(m=>o.get(m)),u=d.operands.map(m=>o.get(m));return h.sort((m,f)=>m-f),u.sort((m,f)=>m-f),Ge(h,u,(m,f)=>m-f)}}}let s=0;const o=new Map,i=[];return n.forEach(a=>{a.sort(r),i.push(a[0]),o.set(a[0],s++);for(let d=1;d<a.length;d++)r(a[d-1],a[d])===0?o.set(a[d],o.get(a[d-1])):(i.push(a[d]),o.set(a[d],s++))}),i.forEach((a,d)=>{switch(a.operation){case"add":case"mul":case"min":case"max":i[d]={...a,operands:[...a.operands].sort((l,c)=>o.get(l)-o.get(c))}}}),ge(e,a=>i[o.get(a)],a=>a)}function Ue(e,t,n=r=>!1){const r={data:[],processed:new Map},s=new Map([[r,new Map]]),o={data:[t],processed:new Map};return s.set(o,new Map),s.get(r).set(t,o),Ye(e,o,(i,a,d)=>{const{operation:l}=i,c=(h,u)=>d(h,u),g=(h,u)=>d(h,u);let p;switch(l){case"const":p=i;break;case"add":case"mul":case"max":case"min":{const h=Q[l],u=[],m=i.operands.filter(b=>{const y=c(b,a);return y.operation==="const"?(u.push(y.value),!1):!0}).map(b=>c(b,a)),f=h(u);if(isFinite(f)){if(l==="mul"&&f===0){p=R(f);break}}else if(l!=="mul"&&(l!=="max"||f>0)&&(l!=="min"||f<0)){p=R(f);break}f!==h([])&&m.push(R(f)),m.length<=1?p=m[0]??R(h([])):p={operation:l,operands:m};break}case"res":case"sum_frac":{const h=i.operands.map(m=>c(m,a)),u=Q[l];h.every(m=>m.operation==="const")?p=R(u(h.map(m=>m.value))):p={...i,operands:h};break}case"lookup":{const h=g(i.operands[0],a);if(h.operation==="const"){const u=i.table[h.value]??i.operands[1];if(u){p=d(u,a);break}}throw new Error(`Unsupported ${l} node while folding`)}case"prio":{const h=i.operands.find(u=>{const m=g(u,a);if(m.operation!=="const")throw new Error(`Unsupported ${l} node while folding`);return m.value!==void 0});p=h?g(h,a):R(void 0);break}case"small":{let h;for(const u of i.operands){const m=g(u,a);if(m.operation!=="const")throw new Error(`Unsupported ${l} node while folding`);((h==null?void 0:h.value)===void 0||m.value!==void 0&&m.value<h.value)&&(h=m)}p=h??R(void 0);break}case"match":{const[h,u,m,f]=i.operands.map(b=>d(b,a));if(h.operation!=="const"||u.operation!=="const")throw new Error(`Unsupported ${l} node while folding`);p=h.value===u.value?m:f;break}case"threshold":{const[h,u,m,f]=i.operands.map(b=>d(b,a));m.operation==="const"&&f.operation==="const"&&m.value===f.value?p=m:h.operation==="const"&&u.operation==="const"?p=h.value>=u.value?m:f:p={...i,operands:[h,u,m,f]};break}case"subscript":{const h=c(i.operands[0],a);if(h.operation!=="const")throw new Error("Found non-constant subscript node while folding");p=R(i.list[h.value]);break}case"read":{const h=a.data.map(u=>kt(u,i.path)).filter(u=>u);if(h.length===0)if(n(i)){const{accu:u}=i;u===void 0||u==="small"?p=i.type==="string"?R(void 0):R(NaN):p=R(Q[u]([]))}else p=i;else i.accu===void 0||h.length===1?p=d(h[h.length-1],a):p=d({operation:i.accu,operands:h},a);break}case"data":{i.reset&&(a=r);const h=s.get(a);let u=h.get(i.data);u||(u={data:[...a.data,i.data],processed:new Map},s.set(u,new Map),h.set(i.data,u)),p=d(i.operands[0],u);break}default:Z(l)}return p.info&&(p={...p},delete p.info),p})}const Xt=Me(D.lvl,Tt,w("crystallize_level_multi_")),Jt=x(40/9,ce(D.total.eleMas,1400)),pt=T(x(T(_(I,Jt),{pivot:!0,...w("base_crystallize_multi_")}),Xt),w("crystallize")),mt=Me(D.lvl,Ve,w("transformative_level_multi")),ht=x(16,ce(D.total.eleMas,2e3)),k={...M(Object.keys(ee),e=>{const{multi:t,resist:n,canCrit:r}=ee[e];return T(x(x(R(t,w(`${e}_multi_`)),mt),_(T(_(I,ht),{pivot:!0,...w("base_transformative_multi_")}),D.total[`${e}_dmg_`]),G(D.hit.hitMode,{hit:I,critHit:r?_(I,D.total[`${e}_critDMG_`]):I,avgHit:r?_(I,x(T(ze(_e(D.total[`${e}_critRate_`],_(I,I)),fe),{...D.total[`${e}_critRate_`].info,pivot:!0}),D.total[`${e}_critDMG_`])):I},NaN),D.enemy.transDef,D.enemy[`${n}_resMulti_`]),w(`${e}_hit`))}),swirl:M(ee.swirl.variants,e=>{const t=x(x(R(ee.swirl.multi,w("swirl_multi_")),mt),_(T(_(I,ht),{pivot:!0,...w("base_transformative_multi_")}),D.total.swirl_dmg_)),n=D.enemy[`${e}_resMulti_`];return T(["pyro","hydro","cryo","electro"].includes(e)?e==="electro"?Qe(x(_(t,D.hit.addTerm),n),{hit:{ele:R(e)}}):Qe(x(t,n,D.hit.ampMulti),{hit:{ele:R(e)}}):x(t,n),w(`${e}_swirl_hit`))})},E={overloaded:T(Je(_(q(ne,"pyro",1),q(ne,"electro",1)),1,k.overloaded),w("overloaded_hit")),electrocharged:T(Je(_(q(ne,"hydro",1),q(ne,"electro",1)),1,k.electrocharged),w("electrocharged_hit")),superconduct:T(q(ne,"cryo",k.superconduct),w("superconduct_hit")),burning:T(q(ne,"pyro",k.burning),w("burning_hit")),bloom:T(q(ne,"hydro",k.bloom),w("bloom_hit")),burgeon:T(q(ne,"pyro",k.burgeon),w("burgeon_hit")),hyperbloom:T(q(ne,"electro",k.hyperbloom),w("hyperbloom_hit"))};k.swirl.electro,k.swirl.pyro,k.swirl.cryo,k.swirl.hydro,k.overloaded,k.electrocharged,k.superconduct,k.shattered,k.burning,k.bloom,k.burgeon,k.hyperbloom,{...Object.fromEntries(Ot.map(e=>[`${e}Crystallize`,T(x(le(2.5),pt),w(`${e}_crystallize`))])),shattered:k.shattered,overloaded:E.overloaded,electrocharged:E.electrocharged,superconduct:E.superconduct,burning:E.burning,bloom:E.bloom,burgeon:E.burgeon,hyperbloom:E.hyperbloom},k.overloaded,k.electrocharged,k.superconduct,k.shattered,k.hyperbloom,E.burning,E.bloom,E.burgeon,k.electrocharged,k.shattered,k.bloom,E.overloaded,E.superconduct,E.burning,E.burgeon,E.hyperbloom,k.overloaded,k.shattered,k.burning,k.burgeon,E.electrocharged,E.superconduct,E.bloom,E.hyperbloom,k.superconduct,k.shattered,E.overloaded,E.electrocharged,E.burning,E.bloom,E.burgeon,E.hyperbloom,k.shattered,k.burning,k.bloom,E.overloaded,E.electrocharged,E.superconduct,E.burgeon,E.hyperbloom;function ft(e,t,n,r,s,o){let i=o;const a={pruneOrder:{pruneNodeRange:!0},pruneArtRange:{pruneNodeRange:!0},pruneNodeRange:{reaffine:!0},reaffine:{pruneOrder:!0,pruneArtRange:!0,pruneNodeRange:!0}};let d=0;for(;Object.values(i).some(l=>l)&&d++<20;){if(i.pruneOrder){delete i.pruneOrder;const l=Yt(n,r,s);n!==l&&(n=l,i={...i,...a.pruneOrder})}if(i.pruneArtRange){delete i.pruneArtRange;const l=Zt(e,n,t);n!==l&&(n=l,i={...i,...a.pruneArtRange})}if(i.pruneNodeRange){delete i.pruneNodeRange;const l=en(e,n);e!==l&&(e=l,i={...i,...a.pruneNodeRange})}if(i.reaffine){delete i.reaffine;const{nodes:l,arts:c}=Qt(e,n);(e!==l||n!==c)&&(e=l,n=c,i={...i,...a.reaffine})}}return{nodes:e,arts:n}}function Qt(e,t,n=!1){const r=new Set,s=new Set;function o(u,m){return m?r.add(u):u.operands.forEach(f=>r.has(f)&&s.add(f)),u}const i=new Set;if(e=ge(e,u=>u,u=>{const{operation:m}=u;switch(m){case"read":return i.add(u.path[1]),o(u,!0);case"add":{const f=u.operands.filter(v=>r.has(v)),b=u.operands.filter(v=>!r.has(v));if(b.length===0)return o(u,!0);if(f.length<=1)return o(u,!1);const y=o(_(...f),!0);return o(_(y,...b),!1)}case"mul":{const f=u.operands.filter(b=>b.operation!=="const");return o(u,f.length===0||f.length===1&&r.has(f[0]))}case"const":return o(u,!0);case"res":case"threshold":case"sum_frac":case"max":case"min":return o(u,!1);default:Z(m)}}),e.filter(u=>r.has(u)).forEach(u=>s.add(u)),[...s].every(({operation:u})=>u==="read"||u==="const")&&Object.keys(t.base).length===i.size)return{nodes:e,arts:t};let a=-1;function d(){for(;i.has(`${++a}`););return`${a}`}const l=[...s].filter(u=>u.operation!=="const"),c=new Map(l.map(u=>[u,!n&&u.operation==="read"&&u.path[0]==="dyn"?u:Ct(d())]));e=ge(e,u=>c.get(u)??u,u=>u);function g(u){const m=Ue([...c.keys()],{dyn:re(u,f=>R(f))},f=>!0);return Object.fromEntries([...c.values()].map((f,b)=>[f.path[1],m[b].value]))}const p={nodes:e,arts:{base:g(t.base),values:M(B,u=>t.values[u].map(({id:m,set:f,values:b})=>({id:m,set:f,values:g(b)})))}},h=Object.entries(g({}));for(const u of Object.values(p.arts.values))for(const{values:m}of u)for(const[f,b]of h)m[f]-=b;return p}function Yt(e,t,n){var l;let r=!1;const s=!((l=n.rainbow)!=null&&l.length),o=Object.keys(e.base),i=new Set(Object.entries(n).filter(([c,g])=>g.length).map(([c])=>c)),a=new Set(Object.entries(n).filter(([c,g])=>g.includes(2)&&!g.includes(4)).map(([c])=>c)),d=M(B,c=>{const g=e.values[c],p=g.filter(h=>{let u=0;return g.every(m=>{const f=o.every(O=>(m.values[O]??0)>=(h.values[O]??0)),b=o.some(O=>(m.values[O]??0)>(h.values[O]??0)),y=f&&(b||m.id>h.id),v=s&&!i.has(m.set)&&!a.has(h.set)||h.set===m.set;return y&&v&&u++,u<t})});return p.length!==g.length&&(r=!0),p});return r?{base:e.base,values:d}:e}function Zt(e,t,n){const r=Object.fromEntries(Object.entries(t.base).map(([o,i])=>[o,{min:i,max:i}])),s={arts:t};for(;;){const o=M(B,l=>Ne(s.arts.values[l])),i=M(B,l=>Se(Object.entries(o).map(c=>c[0]===l?r:c[1]).filter(c=>c)));let a=!1;const d=M(B,l=>{const c=s.arts.values[l].filter(g=>{const p=Se([Ne([g]),i[l]]),h=Ke(e,p);return e.every((u,m)=>h.get(u).max>=(n[m]??-1/0))});return c.length!==s.arts.values[l].length&&(a=!0),c});if(!a)break;s.arts={base:s.arts.base,values:d}}return s.arts}function en(e,t){const n=Object.fromEntries(Object.entries(t.base).map(([o,i])=>[o,{min:i,max:i}])),r=Se([n,...Object.values(t.values).map(o=>Ne(o))]),s=Ke(e,r);return ge(e,o=>{{const{min:d,max:l}=s.get(o);if(d===l)return R(d)}const{operation:i}=o,a=o.operands.map(d=>s.get(d));switch(i){case"threshold":{const[d,l,c,g]=a;if(d.min>=l.max)return o.operands[2];if(d.max<l.min)return o.operands[3];if(c.max===c.min&&g.max===g.min&&c.min===g.min&&isFinite(c.min))return R(c.max);break}case"min":{const d=o.operands.filter((l,c)=>{const g=a[c];return a.every(p=>g.min<=p.max)});if(d.length<a.length)return _e(...d);break}case"max":{const d=o.operands.filter((l,c)=>{const g=a[c];return a.every(p=>g.max>=p.min)});if(d.length<a.length)return ze(...d);break}}return o},o=>o)}function Se(e){const t={};return e.forEach(n=>{Object.entries(n).forEach(([r,s])=>{t[r]?(t[r].min+=s.min,t[r].max+=s.max):t[r]={...s}})}),t}function Ne(e){const t={};return e.length&&(Object.keys(e[0].values).filter(n=>e.every(r=>r.values[n])).forEach(n=>t[n]={min:e[0].values[n],max:e[0].values[n]}),e.forEach(({values:n})=>{for(const[r,s]of Object.entries(n))t[r]?(t[r].max<s&&(t[r].max=s),t[r].min>s&&(t[r].min=s)):t[r]={min:0,max:s}})),t}function He(e){const t=Object.fromEntries(Object.entries(e.base).map(([n,r])=>[n,{min:r,max:r}]));return Se([t,...Object.values(e.values).map(n=>Ne(n))])}function Ke(e,t){const n=new Map;return $e(e,r=>{},r=>{const{operation:s}=r,o=r.operands.map(a=>n.get(a));let i;switch(s){case"read":if(r.path[0]!=="dyn")throw new Error(`Found non-dyn path ${r.path} while computing range`);i=t[r.path[1]]??{min:0,max:0};break;case"const":i=je([r.value]);break;case"add":case"min":case"max":i={min:Q[s](o.map(a=>a.min)),max:Q[s](o.map(a=>a.max))};break;case"res":i={min:Q[s]([o[0].max]),max:Q[s]([o[0].min])};break;case"mul":i=o.reduce((a,d)=>je([a.min*d.min,a.min*d.max,a.max*d.min,a.max*d.max]));break;case"threshold":o[0].min>=o[1].max?i=o[2]:o[0].max<o[1].min?i=o[3]:i=je([],[o[2],o[3]]);break;case"sum_frac":{const[a,d]=o,l={min:a.min+d.min,max:a.max+d.max};l.min<=0&&l.max>=0?i=a.min<=0&&a.max>=0?{min:NaN,max:NaN}:{min:-1/0,max:1/0}:i=je([a.min/l.min,a.min/l.max,a.max/l.min,a.max/l.max]);break}default:Z(s)}n.set(r,i)}),n}function je(e,t=[]){const n=Math.max(...e,...t.map(s=>s.max));return{min:Math.min(...e,...t.map(s=>s.min)),max:n}}function pe(e,t){return{base:e.base,values:M(B,n=>{const r=t[n];switch(r.kind){case"id":return e.values[n].filter(s=>r.ids.has(s.id));case"exclude":return e.values[n].filter(s=>!r.sets.has(s.set));case"required":return e.values[n].filter(s=>r.sets.has(s.set))}})}}function tn(e){let t=.01;const n=2,r=1500;let s=new Set(e.flatMap(i=>Object.values(i).map(a=>Math.round(a.plot/t))));for(;s.size>r;)t*=n,s=new Set([...s].map(i=>Math.round(i/n)));const o={};for(const i of e)for(const a of Object.values(i)){const d=Math.round(a.plot/t)*t;(!o[d]||o[d].value<a.value)&&(o[d]=a)}return o}function Y(e){return B.reduce((t,n)=>t*e.values[n].length,1)}function*nn(e,t){const n=re(t.values,r=>new Set(r.map(s=>s.set)));e:for(const r of e){for(const[s,o]of Object.entries(r)){const i=n[s];switch(o.kind){case"required":if([...o.sets].every(a=>!i.has(a)))continue e;break;case"exclude":if([...i].every(a=>o.sets.has(a)))continue e;break}}yield r}}function gt(e){return new Set(e!=null&&e.includes(2)?e.includes(4)?[0,1]:[0,1,4,5]:e!=null&&e.includes(4)?[0,1,2,3]:[0,1,2,3,4,5])}function*rn(e,t){const n=[...new Set(t)],r=gt(e.rainbow);let s=[];function o(p,h,u){if(p.length===5){r.has(u.length)&&s.push(p);return}for(const m of h)o([...p,m],h,u.filter(f=>f!==m));o([...p,p.length],new Set([...h,p.length]),[...u,p.length])}o([0],new Set([0]),[0]);function i(p,h){if(!ye(h+1,4).some(u=>p[u]!==5))return p=[...p],p[h]=5,p.reduce((u,m)=>u*6+m,0)}for(let p=4;p>=0;p--){const h=new Map;for(const u of s){const m=i(u,p);m!==void 0&&h.set(m,(h.get(m)??new Set(u.slice(0,p)).size+1)-1)}for(const[u,m]of h.entries())if(m===0){const f=[...s.find(b=>i(b,p)===u)];f[p]=5,s=s.filter(b=>i(b,p)!==u),s.push(f)}}const a={kind:"exclude",sets:new Set},d=M(B,p=>a),l={...re(e,p=>0),...M(n,p=>0)},c=re(e,gt);function*g(p){const h=new Set,u=[];let m=[];for(const v of p)m.push([]),v===5?u.push(m.length-1):m[v].push(m.length-1);m=m.filter(v=>v.length).sort((v,O)=>O.length-v.length);let f=u.length;function*b(v){if(v===m.length)return yield*y(0);for(const O of n){if(h.has(O))continue;const C=m[v].length,N=c[O];let P=0;N&&!N.has(C)&&(P=(ye(C+1,5).find(j=>N.has(j))??6)-C,P>f)||(h.add(O),l[O]=m[v].length,m[v].forEach(j=>d[B[j]]={kind:"required",sets:new Set([O])}),f-=P,yield*b(v+1),f+=P,l[O]=0,h.delete(O))}}function*y(v){const O=u.length-v,C=[],N=[],P=[];let j=0;for(const V of n){const U=c[V],W=l[V];U&&(ye(1,O).every(ie=>!U.has(W+ie))?P.push(V):U.has(W)?ye(0,O).some(ie=>!U.has(W+ie))&&C.push(V):(j+=[...U].find(ie=>ie>W)-W,N.push(V)))}if(!(j>O)){if(v===u.length){yield{...d};return}if(j===O){for(const V of N)l[V]++,d[B[u[v]]]={kind:"required",sets:new Set([V])},yield*y(v+1),l[V]--;return}for(const V of[...C,...N])l[V]++,d[B[u[v]]]={kind:"required",sets:new Set([V])},yield*y(v+1),l[V]--;d[B[u[v]]]={kind:"exclude",sets:new Set([...N,...P,...C])},yield*y(v+1)}}yield*b(0)}for(const p of s)yield*g(p)}function sn(e,t){const n=He(t),r=[...new Set(e.flatMap(o=>Object.keys(o).filter(i=>i!=="$c")))],{bestKey:s}=r.reduce(({bestKey:o,minHeur:i},a)=>{const{min:d,max:l}=n[a],c=e.reduce((m,f)=>m+((l-d)*(f[a]??0))**2,0),{lowerRange:g,upperRange:p}=B.reduce(({lowerRange:m,upperRange:f},b)=>{const y=t.values[b].map(j=>j.values[a]),v=Math.min(...y),O=Math.max(...y),C=(v+O)/2,N=Math.max(...y.filter(j=>j<=C)),P=Math.min(...y.filter(j=>j>=C));return{lowerRange:m+(N-v),upperRange:f+(O-P)}},{lowerRange:0,upperRange:0}),u=e.reduce((m,f)=>m+(g*(f[a]??0))**2+(p*(f[a]??0))**2,0)/2-c;return u<i?{bestKey:a,minHeur:u}:{bestKey:o,minHeur:i}},{bestKey:"",minHeur:1/0});return{splitOn:s,splitVal:(n[s].min+n[s].max)/2}}function an(e,t){return bt(t,n=>n.map(r=>r.set===e))}function on(e,t,n){t-=n.base[e];const r=B.map(l=>n.values[l].map(c=>({art:c,val:c.values[e]})).sort((c,g)=>c.val-g.val)),s=r.map(([l])=>l.val),o=r.map(l=>l[l.length-1].val-l[0].val),i=o.reduce((l,c)=>l+c),a=(t-s.reduce((l,c)=>l+c))/Math.max(i,1e-9),d=r.map((l,c)=>{const g=s[c]+a*o[c];let p=0,h=l.length;for(;p!==h;){const u=Math.floor((p+h)/2);g>l[u].val?p=u+1:h=u}return h});return bt(n,(l,c)=>{const g=new Set(r[c].slice(d[c]).map(p=>p.art));return l.map(p=>g.has(p))})}function bt({base:e,values:t},n){const r=B.map((s,o)=>{const i=t[s],a=n(i,o);return[i.filter((d,l)=>a[l]),i.filter((d,l)=>!a[l])].filter(d=>d.length)});return Fe(...r).map(s=>({base:e,values:M(B,(o,i)=>s[i])})).sort((s,o)=>Y(o)-Y(s))}function De(e){return{type:"lin",lin:{$c:e},min:e,max:e}}function ln(e,t){return{type:"lin",lin:{[e]:1,$c:0},...t}}function qe(...e){const t=e.filter(r=>typeof r=="number").reduce((r,s)=>r+s,0),n=e.filter(r=>typeof r!="number");return{type:"sum",terms:n,$c:t,min:n.reduce((r,{min:s})=>r+s,t),max:n.reduce((r,{max:s})=>r+s,t)}}function Ie(...e){const t=e.filter(s=>typeof s=="number").reduce((s,o)=>s*o,1),n=e.filter(s=>typeof s!="number"),r=n.reduce(({min:s,max:o},{min:i,max:a})=>({min:Math.min(s*i,s*a,o*i,o*a),max:Math.max(s*i,s*a,o*i,o*a)}),{min:t,max:t});return{type:"prod",terms:n,$k:t,...r}}function We(e,t,n,r){return qe(n-e*t,Ie(e,r))}function yt(e,t,n,r,s,o){return Math.abs(e-n)<1e-10?De(o?Math.max(t,r):Math.min(t,r)):We((r-t)/(n-e),e,t,s)}function cn(e,t){const n=new Map;$e(e,l=>{const{operation:c}=l;switch(c==="mul"&&n.set(l,{min:NaN,max:NaN}),c){case"mul":case"min":case"max":case"threshold":case"res":case"sum_frac":l.operands.forEach(g=>n.set(g,{min:NaN,max:NaN}))}},l=>l);const r=He(t),s=Ke([...n.keys()],r);for(const[l,c]of s.entries())n.set(l,c);const o="u",i="l",a="e";return Ye(e,o,(l,c,g)=>{const{operation:p}=l,h=(m,f=c)=>g(m,f),u=c===o?i:o;switch(p){case"const":return De(l.value);case"read":return ln(l.path[1],n.get(l));case"add":return qe(...l.operands.map(m=>h(m)));case"mul":{if(c===a)return Ie(...l.operands.map(N=>h(N)));const{min:m,max:f}=n.get(l);if(m===f)return De(m);if(m*f<0||l.operands.some(N=>{const{min:P,max:j}=n.get(N);return P*j<0}))return h(l,a);const y=m===0?f:m,v=Q[p],O=v(l.operands.filter(N=>N.operation==="const").map(N=>N.value)),C=l.operands.filter(N=>N.operation!=="const").map(N=>{const{min:P,max:j}=n.get(N),U=y*(P===0?j:P)>0?c:u,W=h(N,U);if(U===i&&j>0&&W.min<-P||U===o&&P<0&&W.max>-j)throw new K("Unallowed large crossing post approximation",p);return W});return Ie(O,...C)}case"min":case"max":{if(c===a)throw new K("Cannot be exactly represented",p);const m=Q[p],f=l.operands.filter(j=>j.operation!=="const"),[b]=f;if(f.length!==1)throw new K("Multivariate",p);const y=h(b),v=m(l.operands.filter(j=>j.operation==="const").map(j=>j.value));if(p==="max"&&c===i||p==="min"&&c===o)return y;const{min:O,max:C}=n.get(b),N=m([O,v]),P=m([C,v]);return yt(O,N,C,P,y,c===o)}case"res":{if(c===a)throw new K("Cannot be exactly represented",p);if(c===i)throw new K("Unsupported direction",p);const m=Q[p],[f]=l.operands,{min:b,max:y}=n.get(f),v=h(f,u);return b<0&&y<1.75?qe(1,Ie(-.5,v)):yt(b,m([b]),y,m([y]),v,c===o)}case"sum_frac":{if(c===a)throw new K("Cannot be exactly represented",p);if(c===i)throw new K("Unsupported direction",p);const[m,f]=l.operands;if(f.operation!=="const")throw new K("Non-constant node",p);const b=h(m),y=f.value,{min:v,max:O}=n.get(m);if(v<=-y)throw new K("Unallowed negative argument",p);const C=Math.sqrt((v+y)*(O+y));return We(y/(C+y)/(C+y),C,C/(C+y),b)}case"threshold":{if(c===a)throw new K("Cannot be exactly represented",p);const[m,f,b,y]=l.operands;if(f.operation!=="const")throw new K("Non-constant node",p);const{min:v,max:O}=n.get(m);if(v>=f.value)return h(b);if(O<f.value)return h(y);if(y.operation!=="const")throw new K("Non-constant node",p);if(b.operation!=="const"){if(y.value!==0)throw new K("Unsupported pattern",p);const U=It(m,f,1,y),W=x(U,b),{min:ie,max:Rn}=n.get(b);return n.set(U,{min:0,max:1}),n.set(W,{min:Math.min(ie,0),max:Math.max(Rn,0)}),h(W)}const C=f.value,N=b.value,P=y.value,j=N>P==(c===o),V=h(m,j?o:i);if(j){const U=(N-P)/(C-v);return We(U,C,N,V)}return De(P)}default:Z(p)}}).map(l=>hn(l))}function Le(e){return{$k:e,terms:[]}}function un(e,t){return{$k:t,terms:[e]}}function dn(...e){return e.flat()}function pn(...e){return Fe(...e).map(t=>t.reduce((n,r)=>(n.$k*=r.$k,n.terms.push(...r.terms),n),{$k:1,terms:[]}))}function mn(e){e.forEach(t=>t.terms.sort()),e.sort(({terms:t},{terms:n})=>{if(t.length!==n.length)return t.length-n.length;for(let r=0;r<t.length;r++)if(t[r]!==n[r])return t[r]<n[r]?-1:1;return 0});for(let t=e.length-2;t>=0;t--){if(e[t].$k===0){e.splice(t,1);continue}const n=e[t].terms,r=e[t+1].terms;n.length===r.length&&n.every((s,o)=>s===r[o])&&(e[t].$k=e[t].$k+e[t+1].$k,e.splice(t+1,1))}return e}function hn(e){function t(n){switch(n.type){case"lin":return Object.entries(n.lin).filter(([r,s])=>s!==0).map(([r,s])=>r==="$c"?Le(s):un(r,s));case"sum":return dn(...n.terms.map(r=>t(r)),[Le(n.$c)]);case"prod":return pn(...n.terms.map(r=>t(r)),[Le(n.$k)])}}return mn(t(e))}class K extends Error{constructor(t,n){super(`Found ${t} in ${n} node when generating polynomial upper bound`)}}const oe=1e-8;function fn(e,t){const n=t.length;return e.every(r=>t.reduce((s,o,i)=>s+o*r[i],0)<=r[n]+oe)}function gn(e,t){const n=t.length+1,r=t[0].length,s=Array(n).fill(0).map(a=>Array(r).fill(0));t.forEach((a,d)=>a.forEach((l,c)=>s[d][c]=l)),e.forEach((a,d)=>s[n-1][d]=a);const o=[];for(;s.some((a,d)=>d<n-1&&a[r-1]<-oe);){const a=yn(s);o.push(a),vt(s,a)}for(;s[n-1].some((a,d)=>d<r-1&&a<-oe);){const a=bn(s);o.push(a),vt(s,a)}const i=e.map((a,d)=>vn(s,o,d));if(!fn(t,i))throw Error("COMPUTED SOLUTION IS NOT FEASIBLE");return i}function vt(e,{i:t,j:n}){const r=e[t][n];for(let s=0;s<e.length;s++)if(s!==t)for(let o=0;o<e[0].length;o++)o!==n&&(e[s][o]-=e[t][o]*e[s][n]/r);for(let s=0;s<e.length;s++)s!==t&&(e[s][n]=-e[s][n]/r);for(let s=0;s<e[0].length;s++)s!==n&&(e[t][s]=e[t][s]/r);e[t][n]=1/r}function bn(e){const t=e.length,n=e[0].length;let r={i:-1,j:-1,cmp:1/0};for(let s=0;s<n-1;s++)if(!(e[t-1][s]>=-oe)){for(let o=0;o<t-1;o++)if(e[o][s]>oe){const i=e[o][n-1]/e[o][s];i<r.cmp&&(r={i:o,j:s,cmp:i})}if(r.i<0)throw Error("UNBOUNDED FEASIBLE")}if(r.i<0)throw Error("NO PIVOTS (done)");return{i:r.i,j:r.j}}function yn(e){const t=e.length,n=e[0].length;let r={i:-1,j:-1,cmp:1/0};for(let s=0;s<t-1;s++)if(!(e[s][n-1]>=-oe)){for(let o=0;o<n-1;o++)if(e[s][o]<-oe){const i=e[s][n-1]/e[s][o];i<r.cmp&&(r={i:s,j:o,cmp:i})}if(r.i<0)throw Error("INFEASIBLE");return{i:r.i,j:r.j}}throw Error("NO PIVOTS (done)")}function vn(e,t,n){let r=1;t.forEach(({i:o,j:i})=>{r===1&&i===n?(n=o,r=0):r===0&&o===n&&(n=i,r=1)});const s=e[0].length;return r===0?e[n][s-1]:0}function _n(...e){const t={$c:0};for(const[n,r]of e)for(const[s,o]of Object.entries(r))t[s]=(t[s]??0)+n*o;return t}function _t(e,t){const n=cn(e,t),r=He(t);return n.map(s=>_n(...s.map(o=>{const i=o.terms.map(c=>r[c]),{w:a,$c:d}=wn(i,o.$k>=0?"upper":"lower"),l={$c:d};return o.terms.forEach((c,g)=>l[c]=a[g]+(l[c]??0)),[o.$k,l]})))}function wn(e,t="upper"){if(e.length===0)return{w:[],$c:1,err:0};const n=e.length,r=e.map(({min:a,max:d})=>Math.max(-a,d));if(r.some(a=>a===0))return{w:e.map(a=>0),$c:0,err:0};const s=r.reduce((a,d)=>a*d,1);e=e.map(({min:a,max:d},l)=>({min:a/r[l],max:d/r[l]}));const o=Fe(...e.map(({min:a,max:d})=>[a,d])).flatMap(a=>{const d=a.reduce((c,g)=>c*g,1),l=a.reduce((c,g)=>c+g,0);switch(t){case"upper":return[[...a,-1,0,l-d-n],[...a.map(c=>-c),1,-1,n+d-l]];case"lower":return[[...a.map(c=>-c),-1,0,d-l-n],[...a,1,-1,n+l-d]];default:Z(t)}}),i=[...e.map(a=>0),0,1];try{const a=gn(i,o);switch(t){case"upper":return{w:a.slice(0,n).map((d,l)=>(1-d)*s/r[l]),$c:s*(a[n]-n),err:s*a[n+1]};case"lower":return{w:a.slice(0,n).map((d,l)=>(1-d)*s/r[l]),$c:s*(n-a[n]),err:s*a[n+1]};default:Z(t)}}catch(a){throw console.log("ERROR on bounds",e),console.log("Possibly numerical instability issue."),console.log(a),a}}class Mn{constructor({arts:t,optTarget:n,constraints:r,topN:s},o){this.filters=[],this.firstUncalculated=0,this.arts=t,this.min=[-1/0,...r.map(i=>i.min)],this.nodes=[n,...r.map(i=>i.value)],this.callback=o,this.topN=s,_t(this.nodes,t)}addFilter(t){const n=pe(this.arts,t),r=Y(n);r&&this.filters.push({nodes:this.nodes,arts:n,maxConts:[],lins:[],approxs:[],count:r})}setThreshold(t){t>this.min[0]&&(this.min[0]=t,this.firstUncalculated=0,this.filters.forEach(n=>delete n.calculated))}*split(t,n){for(this.addFilter(t);this.filters.length;){const r=this.getApproxFilter(),{arts:s,count:o}=r;if(o<=n||Object.keys(s.base).length===0){if(!o)continue;this.firstUncalculated<this.filters.length&&this.calculateFilter(this.firstUncalculated++),this.reportInterim(!1),yield re(s.values,i=>({kind:"id",ids:new Set(i.map(a=>a.id))}))}else this.splitOldFilter(r)}this.reportInterim(!0)}reportInterim(t=!1){this.interim&&(this.interim.skipped>1e6||t===!0)&&(this.callback(this.interim),this.interim=void 0)}splitOldFilter(t){const{nodes:n,arts:r,lins:s}=t;if(Y(r)===0)return;const{splitOn:o,splitVal:i}=sn(s,r),a=Xe.includes(o)?an(o,r):on(o,i,r);for(const d of a){const l=Y(d);this.filters.push({nodes:n,arts:d,maxConts:[],lins:[],approxs:[],count:l})}}getApproxFilter(){return this.calculateFilter(this.filters.length-1),this.firstUncalculated>this.filters.length&&(this.firstUncalculated=this.filters.length),this.filters.pop()}calculateFilter(t){let{nodes:n,arts:r,maxConts:s,lins:o,approxs:i}=this.filters[t];const{count:a,calculated:d}=this.filters[t];if(d)return;({nodes:n,arts:r}=ft(n,this.min,r,this.topN,{},{pruneNodeRange:!0})),n=dt(n,{},p=>!1),Object.values(r.values).every(p=>p.length)&&({lins:o,approxs:i}=$n(n,r),s=i.map(p=>re(r.values,h=>kn(h,p))));const l=s.map((p,h)=>Object.values(p).reduce((u,m)=>u+m,i[h].base-this.min[h])),c=re(r.values,(p,h)=>{const u=l.map((m,f)=>s[f][h]-m);return p.filter(({id:m})=>i.every(({conts:f},b)=>f[m]>=u[b]))});r={base:r.base,values:c};const g=Y(r);g!==a&&(this.interim?this.interim.skipped+=a-g:this.interim={resultType:"interim",buildValues:void 0,tested:0,failed:0,skipped:a-g}),this.filters[t]={nodes:n,arts:r,maxConts:s,lins:o,approxs:i,count:g,calculated:!0}}}function kn(e,t){return Math.max(...e.map(({id:n})=>t.conts[n]))}function $n(e,t){const n=_t(e,t);return{lins:n,approxs:n.map(r=>({base:wt(t.base,r,r.$c),conts:he(Object.values(t.values).flat(),s=>[s.id,wt(s.values,r,0)])}))}}function wt(e,t,n){return Object.entries(e).reduce((r,[s,o])=>r+(t[s]??0)*o,n)}class On{constructor({arts:t,optTarget:n,constraints:r,plotBase:s,topN:o},i){this.builds=[],this.buildValues=void 0,this.threshold=-1/0,this.arts=t,this.min=r.map(a=>a.min),this.topN=o,this.callback=i,this.nodes=r.map(a=>a.value),this.nodes.push(n),s&&(this.plotData={},this.nodes.push(s)),this.nodes=dt(this.nodes,{},a=>!1)}setThreshold(t){this.threshold>t&&(this.threshold=t)}compute(t){const{min:n}=this;let r=pe(this.arts,t);const s=Y(r),o=this.builds.length;let i=this.nodes;({nodes:i,arts:r}=ft(i,n,r,this.topN,{},{pruneArtRange:!0,pruneNodeRange:!0}));const a=Object.values(r.values).sort((p,h)=>p.length-h.length),d=qt(i,r.base,p=>p.path[1],a.length),l=Array(a.length),c={tested:0,failed:0,skipped:s-Y(r)},g=p=>{if(p<0){const h=d(l);if(n.every((u,m)=>u<=h[m])){const u=h[n.length],{builds:m,plotData:f}=this;let b;if(u>=this.threshold&&(b={value:u,artifactIds:l.map(y=>y.id).filter(y=>y)},m.push(b)),f){const y=h[n.length+1];(!f[y]||f[y].value<u)&&(b||(b={value:u,artifactIds:l.map(v=>v.id).filter(v=>v)}),b.plot=y,f[y]=b)}}else c.failed+=1;return}a[p].forEach(h=>{l[p]=h,g(p-1)}),p===0&&(c.tested+=a[0].length,c.tested>65536&&this.interimReport(c))};g(a.length-1),this.interimReport(c,this.builds.length>o)}refresh(t){const{topN:n}=this;Object.keys(this.plotData??{}).length>=1e5&&(this.plotData=tn([this.plotData])),(this.builds.length>=1e3||t)&&(this.builds=this.builds.sort((r,s)=>s.value-r.value).slice(0,n),this.buildValues=this.builds.map(r=>r.value),this.threshold=Math.max(this.threshold,this.buildValues[n-1]??-1/0))}interimReport(t,n=!1){this.refresh(n),this.callback({resultType:"interim",buildValues:this.buildValues,...t}),this.buildValues=void 0,t.tested=0,t.failed=0,t.skipped=0}}class xn{constructor({arts:t},n){this.stack=[],this.arts=t}setThreshold(t){}add(t,n){this.stack.push({filter:t,count:Y(pe(this.arts,t)),splittedBy:n})}*split(t,n){this.add(t,"set");for(let r=this.stack.pop();r;r=this.stack.pop()){const{filter:s,count:o,splittedBy:i}=r;if(o<=n){yield s;continue}switch(i){case"set":this.splitBySet(s);break;case"id":this.splitByID(s,o,n);break;default:Z(i)}}}splitBySet(t){const n=pe(this.arts,t),r=B.map(i=>({slot:i,sets:new Set(n.values[i].map(a=>a.set))})).filter(({sets:i})=>i.size>1);if(!r.length)return this.add(t,"id");const{sets:s,slot:o}=r.reduce((i,a)=>i.sets.size<a.sets.size?i:a);s.forEach(i=>this.add({...t,[o]:{kind:"required",sets:new Set([i])}},"set"))}splitByID(t,n,r){const s=pe(this.arts,t),{slot:o,length:i}=B.map(c=>({slot:c,length:s.values[c].length})).filter(c=>c.length>1).reduce((c,g)=>c.length<g.length?c:g),a=Math.ceil(n/r),d=Math.min(a,i),l=Array(d).fill(0).map(c=>new Set);s.values[o].forEach(({id:c},g)=>l[g%d].add(c)),l.forEach(c=>this.add({...t,[o]:{kind:"id",ids:c}},"id"))}}let Ce,me;async function En(e){const{data:t}=e,{command:n}=t;switch(n){case"split":for(const r of Ce.split(t.filter,t.maxIterateSize))postMessage({command:"iterate",filter:r}),await new Promise(s=>setTimeout(s));break;case"iterate":me.compute(t.filter);break;case"threshold":{Ce.setThreshold(t.threshold),me.setThreshold(t.threshold);return}case"finalize":{me.refresh(!0);const{builds:r,plotData:s}=me;postMessage({resultType:"finalize",builds:r,plotData:s});break}case"count":{const{exclusion:r,maxIterateSize:s}=t,o=me.arts,i=nn(rn(r,[...new Set(Object.values(o.values).flatMap(d=>d.map(l=>l.set)))]),o);let a=0;for(const d of i)postMessage({command:"split",filter:d,maxIterateSize:s}),a+=Y(pe(o,d));postMessage({resultType:"count",count:a});break}case"setup":try{Ce=new Mn(t,r=>postMessage(r))}catch{Ce=new xn(t,r=>postMessage(r))}me=new On(t,r=>postMessage(r));break;default:Z(n)}postMessage({resultType:"done"})}onmessage=async e=>{try{await En(e)}catch(t){postMessage({resultType:"err",message:t.message})}}})();
